//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//

=== Building

==== Initial Setup

1. Install J2SE 11 SDK (or later), which can be downloaded from
 http://www.oracle.com/technetwork/java/javase/downloads/index.html[http://www.oracle.com/technetwork/java/javase/downloads/index.html]

2. Make sure that your JAVA_HOME environment variable is set to the newly installed
 JDK location, and that your PATH includes %JAVA_HOME%\bin (windows) or
 $JAVA_HOME$/bin (unix).

3. Install Maven 3.0.3 (or later), which can be downloaded from
 http://maven.apache.org/download.html[http://maven.apache.org/download.html]. Make sure that your PATH includes
 the MVN_HOME/bin directory.

==== Building

1. Get the code: `git clone https://github.com/apache/unomi.git`
2. Change to the top level directory of Apache Unomi source distribution.
3. Run
+
[source]
----
     $> mvn clean install
----
+
This will compile Apache Unomi and run all of the tests in the
 Apache Unomi source distribution. Alternatively, you can run
+
[source]
----
     $> mvn -P \!integration-tests clean install
----
+
This will compile Apache Unomi without running the tests and takes less
 time to build.
+
TIP: On a non-English Windows env, the Asciidoctor Maven Plugin may fail to
     generate manuals due to an encoding conversion issue.
     To solve this issue, we recommend setting the *file.encoding* system property
     to _UTF-8_ like the following examples before issuing the commands shown above.
+
[source]
----
     > set MAVEN_OPTS=-Dfile.encoding=UTF-8
     or
     > set MAVEN_OPTS=-Dfile.encoding=UTF-8 -Xmx2048m
     ...
----
+
. The distributions will be available under "package/target" directory.

==== Installing a Search Engine

Starting with version 1.2, Apache Unomi no longer embeds a search engine server. You must install either Elasticsearch or OpenSearch as a standalone service.

===== Option 1: Using Elasticsearch

1. Download Elasticsearch version 7.17.10 from https://www.elastic.co/downloads/past-releases/elasticsearch-7-17-10

2. Extract the archive:
[source]
----
tar -xzf elasticsearch-7.17.10-darwin-x86_64.tar.gz (Mac)
unzip elasticsearch-7.17.10-windows-x86_64.zip (Windows)
tar -xzf elasticsearch-7.17.10-linux-x86_64.tar.gz (Linux)
----

3. Configure Elasticsearch by editing `config/elasticsearch.yml`:
[source]
----
cluster.name: contextElasticSearch
----

4. Launch the server using:
[source]
----
bin/elasticsearch (Mac, Linux)
bin\elasticsearch.bat (Windows)
----

===== Option 2: Using OpenSearch

The recommended way to run OpenSearch is using Docker Compose:

1. Create a `docker-compose.yml` file with the following content:
[source,yaml]
----
version: '3.8'
services:
  opensearch-node1:
    image: opensearchproject/opensearch:2.18.0
    environment:
      - cluster.name=opensearch-cluster
      - node.name=opensearch-node1
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-admin}
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch-data1:/usr/share/opensearch/data
    ports:
      - 9200:9200
      - 9600:9600

volumes:
  opensearch-data1:
----

2. Set up your Docker host environment:
   * **macOS & Windows**: In Docker _Preferences_ > _Resources_, set RAM to at least 4 GB
   * **Linux**: Ensure `vm.max_map_count` is set to at least 262144

3. Start OpenSearch using:
[source]
----
docker-compose up
----

===== Verify Installation

Check that your search engine is up and running by accessing:
http://localhost:9200[http://localhost:9200]

For OpenSearch with security enabled, you may need to use https and provide the default credentials:
- Username: admin
- Password: admin (or the value of OPENSEARCH_INITIAL_ADMIN_PASSWORD if set)

==== Starting Unomi

After your search engine is running, you can start Unomi using the appropriate command:

[source]
----
# For ElasticSearch
unomi:start elasticsearch

# For OpenSearch
unomi:start opensearch
----

NOTE: Make sure to specify which search engine you're using with the `unomi:start` command. Using just `unomi:start` without specifying the engine is deprecated.

==== Deploying the generated binary package

The "package" sub-project generates a pre-configured Apache Karaf installation that is the simplest way to get started.
Simply uncompress the package/target/unomi-VERSION.tar.gz (for Linux or Mac OS X) or
 package/target/unomi-VERSION.zip (for Windows) archive into the directory of your choice.

You can then start the server simply by using the command on UNIX/Linux/MacOS X :

[source]
----
./bin/karaf
----

or on Windows shell :

[source]
----
bin\karaf.bat
----

You will then need to launch (only on the first Karaf start) the Apache Unomi packages using the following Apache Karaf
shell command:

[source]
----
unomi:start
----

==== Deploying into an existing Karaf server

This is only needed if you didn't use the generated package. Also, this is the preferred way to install a development
environment if you intend to re-deploy the context server KAR iteratively.

Additional requirements:
* Apache Karaf 4.2.x, http://karaf.apache.org[http://karaf.apache.org]

Before deploying, make sure that you have Apache Karaf properly installed. Depending of your usage, you may also have to increase the
 memory size by adjusting the following environment values in the bin/setenv(.bat)
files (at the end of the file):

[source]
----
   MY_DIRNAME=`dirname $0`
   MY_KARAF_HOME=`cd "$MY_DIRNAME/.."; pwd`
   export KARAF_OPTS="$KARAF_OPTS -Xmx3G"
----

Install the WAR support, CXF and Karaf Cellar into Karaf by doing the following in the Karaf command line:

[source]
----
   feature:repo-add cxf-jaxrs 3.3.4
   feature:repo-add cellar 4.1.3
   feature:repo-add mvn:org.apache.unomi/unomi-kar/VERSION/xml/features
   feature:install unomi-kar
----

Create a new $MY_KARAF_HOME/etc/org.apache.cxf.osgi.cfg file and put the following property inside :

[source]
----
   org.apache.cxf.servlet.context=/cxs
----

If all went smoothly, you should be able to access the context script here : http://localhost:8181/cxs/cluster[http://localhost:8181/cxs/cluster] .
 You should be able to login with karaf / karaf and see basic server information. If not something went wrong during the install.

==== Installing GraphViz for Manual Generation

The manual project uses PlantUML diagrams which require GraphViz to be installed. Here's how to install it:

===== On macOS using Homebrew
[source]
----
brew install graphviz
----

===== On Linux (Debian/Ubuntu)
[source]
----
sudo apt-get install graphviz
----

===== On Linux (RHEL/CentOS/Fedora)
[source]
----
sudo dnf install graphviz
----

===== On Windows
1. Download the installer from https://graphviz.org/download/
2. Run the installer
3. Add the GraphViz bin directory to your PATH

===== Building the Manual

You can build the manual directly from the manual directory:

[source]
----
cd manual
mvn clean install
----

The build script will automatically detect and configure the GraphViz path. If you need to set it manually, you can:

1. Set it via environment variable:
[source]
----
export GRAPHVIZ_DOT=/path/to/dot
mvn clean install
----

2. Or specify it directly to Maven:
[source]
----
mvn clean install -Dgraphviz.dot.path=/path/to/dot
----

The generated documentation will be available in:
- HTML: `target/generated-docs/html/latest/`
- PDF: `target/generated-docs/pdf/latest/`

==== JDK Selection on Mac OS X

You might need to select the JDK to run the tests in the itests subproject. In order to do so you can list the
installed JDKs with the following command :

[source]
----
/usr/libexec/java_home -V
----

which will output something like this :

[source]
----
Matching Java Virtual Machines (3):
    11.0.5, x86_64:	"OpenJDK 11.0.5"	/Library/Java/JavaVirtualMachines/openjdk-11.jdk/Contents/Home
    1.8.0_181, x86_64:	"Java SE 8"	/Library/Java/JavaVirtualMachines/jdk1.8.0_181.jdk/Contents/Home
    1.7.0_80, x86_64:	"Java SE 7"	/Library/Java/JavaVirtualMachines/jdk1.7.0_80.jdk/Contents/Home

/Library/Java/JavaVirtualMachines/openjdk-11.jdk/Contents/Home
----

You can then select the one you want using :

[source]
----
export JAVA_HOME=`/usr/libexec/java_home -v 11.0.5`
----

and then check that it was correctly referenced using:

[source]
----
java -version
----

which should give you a result such as this:

[source]
----
openjdk version "11.0.5" 2019-10-15
OpenJDK Runtime Environment (build 11.0.5+10)
OpenJDK 64-Bit Server VM (build 11.0.5+10, mixed mode)
----

==== Running the integration tests

The integration tests are not executed by default to make build time minimal, but it is recommended to run the
integration tests at least once before using the server to make sure that everything is ok in the build. Another way
to use these tests is to run them from a continuous integration server such as Jenkins, Apache Gump, Atlassian Bamboo or
 others.

Note : the integration tests require a JDK 11 or more recent !

To run the tests simply activate the following profile :

[source]
----
mvn -P integration-tests clean install
----

==== Testing with an example page

A default test page is provided at the following URL:

[source]
----
   http://localhost:8181/index.html
----

This test page will trigger the loading of the /cxs/context.js script, which will try to retrieving the user context
or create a new one if it doesn't exist yet. It also contains an experimental integration with Facebook Login, but it
doesn't yet save the context back to the context server.
